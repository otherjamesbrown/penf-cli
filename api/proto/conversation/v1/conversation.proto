// Conversation Service Protobuf Definitions
// Provides gRPC service for conversation queries

syntax = "proto3";

package penfold.conversation.v1;

option go_package = "github.com/otherjamesbrown/penf-cli/api/proto/conversation/v1;conversationv1";

import "google/protobuf/timestamp.proto";
import "content/v1/content.proto";

// =============================================================================
// Service Definition
// =============================================================================

// ConversationService provides gRPC endpoints for querying conversations.
service ConversationService {
  // List conversations with pagination
  rpc ListConversations(ListConversationsRequest) returns (ListConversationsResponse);

  // Get a single conversation with items and participants
  rpc ShowConversation(ShowConversationRequest) returns (ShowConversationResponse);

  // GetConversationProcessingStatus returns aggregated processing status for all items in a conversation.
  rpc GetConversationProcessingStatus(GetConversationProcessingStatusRequest)
      returns (ConversationProcessingStatus);

  // RunConversationAudit detects orphans, duplicates, and merge candidates.
  rpc RunConversationAudit(RunConversationAuditRequest) returns (RunConversationAuditResponse);

  // MergeConversations moves all items from source into target, then deletes source.
  rpc MergeConversations(MergeConversationsRequest) returns (MergeConversationsResponse);

  // SplitConversation extracts specified items into a new conversation.
  rpc SplitConversation(SplitConversationRequest) returns (SplitConversationResponse);

  // UnlinkItem removes a single content item from a conversation.
  rpc UnlinkItem(UnlinkItemRequest) returns (UnlinkItemResponse);
}

// =============================================================================
// List Conversations Messages
// =============================================================================

// ListConversationsRequest requests a paginated list of conversations.
message ListConversationsRequest {
  string tenant_id = 1;
  int32 limit = 2;   // Max results
  int32 offset = 3;  // Pagination offset
  optional string state = 4;  // Filter by state
}

// ListConversationsResponse returns matching conversations.
message ListConversationsResponse {
  repeated ConversationSummary conversations = 1;
  int64 total_count = 2;  // Total matching conversations (for pagination)
}

// ConversationSummary represents a conversation in the list view.
message ConversationSummary {
  string id = 1;
  string tenant_id = 2;
  string topic = 3;
  optional string thread_key = 4;
  google.protobuf.Timestamp first_seen = 5;
  google.protobuf.Timestamp last_seen = 6;
  int32 participant_count = 7;
  int32 item_count = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
  optional string state = 11;
}

// =============================================================================
// Show Conversation Messages
// =============================================================================

// ShowConversationRequest requests a single conversation with details.
message ShowConversationRequest {
  string tenant_id = 1;
  string conversation_id = 2;
}

// ShowConversationResponse returns a conversation with items and participants.
message ShowConversationResponse {
  string id = 1;
  string tenant_id = 2;
  string topic = 3;
  optional string thread_key = 4;
  google.protobuf.Timestamp first_seen = 5;
  google.protobuf.Timestamp last_seen = 6;
  int32 participant_count = 7;
  int32 item_count = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
  repeated ConversationItem items = 11;
  repeated ConversationParticipant participants = 12;
  optional string state_summary = 13;
  int32 summary_version = 14;
  optional google.protobuf.Timestamp summary_updated_at = 15;
  optional string state = 16;
  optional string state_reason = 17;
  optional google.protobuf.Timestamp state_changed_at = 18;
}

// ConversationItem represents a content item in a conversation.
message ConversationItem {
  string conversation_id = 1;
  string content_id = 2;
  optional int64 source_id = 3;
  google.protobuf.Timestamp added_at = 4;
  // Content metadata â€” populated from sources table to avoid N+1 lookups.
  optional google.protobuf.Timestamp content_date = 5;
  optional string from_name = 6;
  optional string subject = 7;
}

// ConversationParticipant represents a participant in a conversation.
message ConversationParticipant {
  string conversation_id = 1;
  optional string name = 2;
  optional string address = 3;
}

// =============================================================================
// GetConversationProcessingStatus Messages
// =============================================================================

// GetConversationProcessingStatusRequest requests the processing status for all
// items in a conversation.
message GetConversationProcessingStatusRequest {
  string conversation_id = 1;
}

// ConversationProcessingStatus contains aggregated processing status for a
// conversation's items, including per-item breakdowns and token totals.
message ConversationProcessingStatus {
  string conversation_id = 1;
  string topic = 2;
  int32 total_items = 3;
  int32 completed = 4;
  int32 processing = 5;
  int32 failed = 6;
  int32 pending = 7;
  repeated ContentProcessingSummary items = 8;
  optional int32 total_input_tokens = 9;
  optional int32 total_output_tokens = 10;
}

// ContentProcessingSummary contains the processing status summary for a single
// content item within a conversation.
message ContentProcessingSummary {
  string content_id = 1;
  int64 source_id = 2;
  penfold.content.v1.ProcessingState state = 3;
  string content_contribution = 4;
  string contribution_reason = 5;
  repeated penfold.content.v1.StageResult stages = 6;
}

// =============================================================================
// Merge Conversations Messages
// =============================================================================

message MergeConversationsRequest {
  string tenant_id = 1;
  string source_conversation_id = 2;  // Will be deleted after merge
  string target_conversation_id = 3;  // Receives all items from source
}

message MergeConversationsResponse {
  string conversation_id = 1;    // Target conversation ID
  int32 items_moved = 2;         // Items moved from source to target
  int32 duplicates_skipped = 3;  // Items already in target (deduped)
  string new_summary = 4;        // Regenerated summary
}

// =============================================================================
// Split Conversation Messages
// =============================================================================

message SplitConversationRequest {
  string tenant_id = 1;
  string conversation_id = 2;       // Source conversation
  repeated string content_ids = 3;  // Items to extract
  optional string new_topic = 4;    // Topic for new conversation (LLM-generated if empty)
}

message SplitConversationResponse {
  string new_conversation_id = 1;   // Newly created conversation
  int32 items_moved = 2;
  string new_topic = 3;             // Actual topic (may be LLM-generated)
}

// =============================================================================
// Unlink Item Messages
// =============================================================================

message UnlinkItemRequest {
  string tenant_id = 1;
  string conversation_id = 2;
  string content_id = 3;
}

message UnlinkItemResponse {
  int32 remaining_items = 1;  // Items left in conversation after removal
}

// =============================================================================
// Conversation Audit Messages
// =============================================================================

message RunConversationAuditRequest {
  string tenant_id = 1;
  bool orphans_only = 2;      // Only run orphan detection
  bool duplicates_only = 3;   // Only run duplicate membership detection
  bool merge_only = 4;        // Only run merge candidate detection
}

message RunConversationAuditResponse {
  int32 conversations_audited = 1;
  repeated AuditFinding flagged = 2;
  repeated AuditOrphan orphans = 3;
  repeated AuditMergeCandidate merge_candidates = 4;
}

message AuditFinding {
  string conversation_id = 1;
  string item_id = 2;
  string reason = 3;
  string suggested_action = 4;  // split, merge, ignore, review
}

message AuditOrphan {
  string content_id = 1;
  string reason = 2;
  string suggested_conversation_id = 3;
}

message AuditMergeCandidate {
  string conversation_id_a = 1;
  string conversation_id_b = 2;
  string topic_a = 3;
  string topic_b = 4;
  string reason = 5;
  repeated string shared_items = 6;
}
